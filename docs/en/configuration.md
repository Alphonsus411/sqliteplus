[Leer en espa√±ol](../configuracion.md)

# Advanced Configuration

## Supported Environment Variables

| Variable | Description |
| --- | --- |
| `HOME` | Used when expanding paths with `~` in `SQLITEPLUS_USERS_FILE`. |
| `PYTEST_CURRENT_TEST` | Automatically detected by pytest to reset temporary databases. |
| `SECRET_KEY` | Mandatory key to sign and validate JWTs issued by the API. Checked at runtime. |
| `JWT_ISSUER` | Issuer (`iss`) of the JWTs. If defined, it is added to the token and also validated when decoding. |
| `JWT_AUDIENCE` | Audience (`aud`) of the JWTs. If defined, it is added to the token and also validated when decoding. |
| `JWT_STRICT_CLAIMS` | Activates strict mode (`1`/`true`/`on`) to require `iss` and `aud` during generation and validation. |
| `SQLITEPLUS_FORCE_RESET` | Requests database reinitialization (values `1`, `true`, or `on`) **only** when the environment is safe (`SQLITEPLUS_ENV=test` or `PYTEST_CURRENT_TEST`). Ignored with a warning in logs outside that context. |
| `SQLITEPLUS_ALLOW_WEAK_USERS_FILE_PERMS` | Allows loading `SQLITEPLUS_USERS_FILE` with weak POSIX permissions (group/others). Use only for legacy compatibility (`1`) and with explicit warnings in logs. |
| `SQLITEPLUS_USERS_FILE` | Path (supports `~`) to the JSON file with users and `bcrypt` hashes. Only mandatory when exposing the API/authentication. |
| `TRUSTED_PROXIES` | Comma-separated list of trusted proxy IPs or CIDRs (e.g., `127.0.0.1,10.0.0.0/8`). **Empty by default**, meaning `Forwarded`/`X-Forwarded-For` are not trusted. |
| `SQLITE_DB_KEY` | SQLCipher key. If not defined, plain text mode is used. If defined empty, the API returns error 503 for security. |

## Client IP Resolution Behind Proxy

The `POST /token` endpoint uses `REMOTE_ADDR` as the primary source of client IP.

- If `TRUSTED_PROXIES` is **not** defined (default behavior), `Forwarded` and `X-Forwarded-For` headers are ignored.
- If `REMOTE_ADDR` matches any IP/network in `TRUSTED_PROXIES`, using `Forwarded` (priority) or `X-Forwarded-For` to identify the original IP is allowed.

This prevents external clients from spoofing their IP when the server is not behind an explicitly trusted proxy.

## Working Directories

- Asynchronous databases are stored in the `databases/` folder by default.
- Backups generated by the CLI reside in `backups/`.
- `SQLiteReplication` copies associated `-wal` and `-shm` files to maintain integrity.

## CLI Options

- `--cipher-key` / `SQLITE_DB_KEY`: allows using SQLCipher in synchronous operations.
- The `export-csv` and `backup` subcommands accept custom paths preserving safe names.

## External Authentication

The file pointed to by `SQLITEPLUS_USERS_FILE` must have the structure:

```json
{
  "admin": "$2b$12$..."
}
```

You can generate new hashes with the `bcrypt` module from Python, as shown in the basic usage guide.

On POSIX platforms, it is also validated that the file does not have excessive permissions for group/others. It is recommended to apply `chmod 600 /path/to/users.json` before starting the API. If you need to temporarily allow weaker permissions for legacy reasons, define `SQLITEPLUS_ALLOW_WEAK_USERS_FILE_PERMS=1` and review the warnings issued in logs.

## JWT Claims Migration (iss/aud)

To facilitate transition without breaking existing clients, the behavior is gradual:

1. **Compatibility (default):** if `JWT_STRICT_CLAIMS` is not active, `iss`/`aud` are issued and validated only when `JWT_ISSUER`/`JWT_AUDIENCE` are defined.
2. **Recommended Strict Mode:** define `JWT_STRICT_CLAIMS=1` along with `JWT_ISSUER` and `JWT_AUDIENCE`. In this mode, a token without those claims is rejected.
3. **HS256 Signature Security:** `SECRET_KEY` must have at least 32 characters and basic entropy.
